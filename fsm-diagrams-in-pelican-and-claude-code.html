<!DOCTYPE html>
<html lang="en">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>FSM Diagrams in Pelican and Claude Code</title>
                        <link rel="stylesheet" href="./theme/css/main.css" />
                                <link href="http://lizard-spock.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Lizard-Spock Atom Feed" />
    <meta name="description" content="Finite state machines turn up everywhere: protocol implementations, hardware controllers, UI flows, parsers. Drawing them well is useful but tedious …" />
        </head>

        <body id="index" class="home">
                <header id="banner" class="body">
                        <h1><a href="./">Lizard-Spock</a></h1>
                        <nav><ul>
                                                <li><a href="./pages/about.html">About</a></li>
                                                <li><a href="./category/cooking.html">Cooking</a></li>
                                                <li class="active"><a href="./category/engineering.html">Engineering</a></li>
                                                <li><a href="./category/home.html">Home</a></li>
                                                <li><a href="./category/outdoor.html">Outdoor</a></li>
                                                <li><a href="./category/photography.html">Photography</a></li>
                                                <li><a href="./category/tech.html">Tech</a></li>
                        </ul></nav>
                </header><!-- /#banner -->
  <section id="content" class="body">
    <article>
      <header>
        <h1 class="entry-title">
          <a href="./fsm-diagrams-in-pelican-and-claude-code.html" rel="bookmark"
             title="Permalink to FSM Diagrams in Pelican and Claude Code">FSM Diagrams in Pelican and Claude Code</a></h1>
      </header>

      <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2026-02-22T18:00:00+00:00">
                Published: Sun 22 February 2026
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="./author/morganp.html">morganp</a>
                </address>
        <p>In <a href="./category/engineering.html">Engineering</a>.</p>
<p>tags: <a href="./tag/fsm.html">fsm</a> <a href="./tag/pelican.html">pelican</a> <a href="./tag/mermaid.html">mermaid</a> <a href="./tag/graphviz.html">graphviz</a> <a href="./tag/claude.html">claude</a> <a href="./tag/ai.html">ai</a> </p>        
</footer><!-- /.post-info -->        <p>Finite state machines turn up everywhere: protocol implementations, hardware controllers, UI flows, parsers. Drawing them well is useful but tedious. This post covers two tools I've built: a Pelican plugin that renders FSM diagrams at build time so they appear as images in published posts, and a Claude Code skill that generates diagrams from plain-English descriptions.</p>
<p>The pattern is identical to the <a href="./wavedrom-timing-diagrams-in-pelican-with-claude-code.html">WaveDrom plugin and skill</a>: describe what you want, get a fenced code block, paste it into a post, and the build renders it to SVG automatically.</p>
<h2>The Pelican plugin</h2>
<p>The plugin is at <a href="https://github.com/morganp/pelican-fsm">github.com/morganp/pelican-fsm</a>, cloned to <code>~/Code/pelican-fsm</code> (a sibling directory to the blog repo). It intercepts fenced <code>```mermaid ```</code> and <code>```dot ```</code> code blocks before Pelican's standard Markdown processing, renders each one to an SVG using the appropriate CLI tool, caches the result by content hash in <code>content/images/fsm/</code>, and replaces the block with a standard image reference. Pelican then copies the SVG to <code>output/images/fsm/</code> as a static asset.</p>
<p>SVGs are cached across builds, so only diagrams whose source has changed are re-rendered.</p>
<h3>Requirements</h3>
<ul>
<li><a href="https://github.com/mermaid-js/mermaid-cli">Mermaid CLI</a> for <code>mermaid</code> blocks:</li>
</ul>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>install<span class="w"> </span>-g<span class="w"> </span>@mermaid-js/mermaid-cli
</code></pre></div>

<ul>
<li><a href="https://graphviz.org/">Graphviz</a> for <code>dot</code> blocks:</li>
</ul>
<div class="highlight"><pre><span></span><code>brew<span class="w"> </span>install<span class="w"> </span>graphviz<span class="w">      </span><span class="c1"># macOS</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>graphviz<span class="w">  </span><span class="c1"># Debian/Ubuntu</span>
</code></pre></div>

<p>Both tools are optional. If one is missing, blocks for that type fall back gracefully to a fenced <code>text</code> block without failing the build.</p>
<h3>Installation</h3>
<p>Clone the plugin alongside your Pelican project and install it into the Pelican virtualenv in editable mode:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/morganp/pelican-fsm<span class="w"> </span>../pelican-fsm
<span class="nb">source</span><span class="w"> </span>venv/bin/activate
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>../pelican-fsm<span class="w"> </span>--config-settings<span class="w"> </span><span class="nv">editable_mode</span><span class="o">=</span>compat
</code></pre></div>

<p>The <code>editable_mode=compat</code> flag is required. Without it, modern setuptools editable installs use a path-hook mechanism that prevents Pelican's namespace plugin auto-discovery from finding the plugin.</p>
<p>Pelican 4.5+ auto-discovers namespace plugins, so no changes to <code>pelicanconf.py</code> are needed.</p>
<h3>Optional config</h3>
<p>If <code>mmdc</code> or <code>dot</code> are not on your <code>PATH</code> during the build, set their full paths in <code>pelicanconf.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">FSM_MERMAID_CLI</span> <span class="o">=</span> <span class="s1">&#39;/opt/homebrew/bin/mmdc&#39;</span>
<span class="n">FSM_DOT_CLI</span> <span class="o">=</span> <span class="s1">&#39;/opt/homebrew/bin/dot&#39;</span>
</code></pre></div>

<h3>Using it in a post</h3>
<p>Write a fenced code block with the language set to <code>mermaid</code> or <code>dot</code>:</p>
<div class="highlight"><pre><span></span><code>![<span class="nt">FSM diagram</span>](<span class="na">{static}/images/fsm/fsm_ea7d29ca092a08571aa2cfe0ccc1600b.svg</span>)
</code></pre></div>

<p>At build time this becomes an SVG embedded in the page:</p>
<p><img alt="FSM diagram" src="./images/fsm/fsm_ea7d29ca092a08571aa2cfe0ccc1600b.svg"></p>
<p>Graphviz DOT works the same way, and is a better fit for hardware and RTL documentation where the compact box-and-arrow style is conventional:</p>
<p><img alt="FSM diagram" src="./images/fsm/fsm_d33619e8d6e9ae49f343c57a8f6db1e1.svg"></p>
<p>If the CLI is not found or rendering fails, the block falls back to fenced <code>text</code> — the post still builds, you just see the raw source instead of a diagram.</p>
<h2>The Claude Code skill</h2>
<p>The skill lives at <a href="https://github.com/morganp/dotfiles/tree/main/config/claude/skills/fsm">github.com/morganp/dotfiles/tree/main/config/claude/skills/fsm</a>. Claude Code auto-discovers skills from <code>~/.claude/skills/</code> and loads them on demand.</p>
<p>The skill triggers automatically when you describe anything involving states, transitions, or control flow: protocol implementations, UI flows, hardware FSMs, parsers, game logic. You describe the system in plain English and Claude generates the diagram.</p>
<p>The skill knows:</p>
<ul>
<li>Full Mermaid <code>stateDiagram-v2</code> syntax: plain states, display labels, transitions with events/guards/actions, composite (nested) states, choice pseudostates, fork/join for parallel regions, concurrent regions (<code>--</code>), notes, direction, and classDef styling</li>
<li>Graphviz DOT FSM conventions: Moore vs Mealy annotation, initial pseudostate arrow, accepting states as double circles</li>
<li>When to prefer each format: Mermaid for software/web docs, DOT for hardware/RTL</li>
</ul>
<h3>Example workflow</h3>
<p>Describe the system:</p>
<blockquote>
<p>"Draw the states for a TCP connection"</p>
</blockquote>
<p>Claude produces:</p>
<p><img alt="FSM diagram" src="./images/fsm/fsm_03bf39c43e71e98bd12e737558c3f9e3.svg"></p>
<p>Because the skill outputs a <code>mermaid</code> fenced block, you can paste it directly into a blog post and the Pelican plugin renders it automatically.</p>
<h3>Installing the skill</h3>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>~/.claude/skills/fsm
curl<span class="w"> </span>-o<span class="w"> </span>~/.claude/skills/fsm/SKILL.md<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>https://raw.githubusercontent.com/morganp/dotfiles/main/config/claude/skills/fsm/SKILL.md
</code></pre></div>

<p>Or clone the dotfiles repo and symlink:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/morganp/dotfiles<span class="w"> </span>~/dotfiles
ln<span class="w"> </span>-s<span class="w"> </span>~/dotfiles/config/claude/skills/fsm<span class="w"> </span>~/.claude/skills/fsm
</code></pre></div>

<h2>Syntax quick reference</h2>
<p>Both formats can express the same FSM concepts, but use different syntax. The table below maps them side by side.</p>
<table>
<thead>
<tr>
<th>Concept</th>
<th>Mermaid <code>stateDiagram-v2</code></th>
<th>Graphviz DOT</th>
</tr>
</thead>
<tbody>
<tr>
<td>Graph declaration</td>
<td><code>stateDiagram-v2</code></td>
<td><code>digraph FSM { ... }</code></td>
</tr>
<tr>
<td>Default node style</td>
<td>automatic</td>
<td><code>node [shape=circle]</code></td>
</tr>
<tr>
<td>Left-to-right layout</td>
<td><code>direction LR</code></td>
<td><code>rankdir=LR</code></td>
</tr>
<tr>
<td>Comment</td>
<td><code>%% comment</code></td>
<td><code>// comment</code></td>
</tr>
<tr>
<td>Plain state</td>
<td><code>StateName</code></td>
<td><code>StateName</code></td>
</tr>
<tr>
<td>State with display label</td>
<td><code>state "Label" as Name</code></td>
<td><code>Name [label="Label"]</code></td>
</tr>
<tr>
<td>Initial pseudostate</td>
<td><code>[*] --&gt; State</code></td>
<td><code>__start [shape=point width=0.2]</code> + <code>__start -&gt; State</code></td>
</tr>
<tr>
<td>Final/accepting state</td>
<td><code>State --&gt; [*]</code></td>
<td><code>State [shape=doublecircle]</code></td>
</tr>
<tr>
<td>Transition</td>
<td><code>A --&gt; B</code></td>
<td><code>A -&gt; B</code></td>
</tr>
<tr>
<td>Transition with event</td>
<td><code>A --&gt; B : event</code></td>
<td><code>A -&gt; B [label="event"]</code></td>
</tr>
<tr>
<td>Transition with action</td>
<td><code>A --&gt; B : event / action()</code></td>
<td><code>A -&gt; B [label="event / action()"]</code></td>
</tr>
<tr>
<td>Guarded transition</td>
<td><code>A --&gt; B : [guard]</code></td>
<td><code>A -&gt; B [label="[guard]"]</code></td>
</tr>
<tr>
<td>Composite (nested) state</td>
<td><code>state S { ... }</code></td>
<td><code>subgraph cluster_S { ... }</code></td>
</tr>
<tr>
<td>Choice pseudostate</td>
<td><code>state C &lt;&lt;choice&gt;&gt;</code></td>
<td><code>C [shape=diamond]</code></td>
</tr>
<tr>
<td>Fork pseudostate</td>
<td><code>state F &lt;&lt;fork&gt;&gt;</code></td>
<td>invisible node + multiple outgoing edges</td>
</tr>
<tr>
<td>Join pseudostate</td>
<td><code>state J &lt;&lt;join&gt;&gt;</code></td>
<td>invisible node + multiple incoming edges</td>
</tr>
<tr>
<td>Concurrent regions</td>
<td><code>--</code> inside composite</td>
<td>parallel <code>subgraph</code> blocks</td>
</tr>
</tbody>
</table>
<h2>Project structure</h2>
<div class="highlight"><pre><span></span><code><span class="o">~/</span><span class="n">Code</span><span class="o">/</span>
<span class="err">├──</span><span class="w"> </span><span class="n">morganp</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="w">              </span><span class="c1"># blog source (main branch)</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">content</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">fsm</span><span class="o">/</span><span class="w">         </span><span class="c1"># SVG cache (persists across make clean)</span>
<span class="err">└──</span><span class="w"> </span><span class="n">pelican</span><span class="o">-</span><span class="n">fsm</span><span class="o">/</span><span class="w">                    </span><span class="c1"># github.com/morganp/pelican-fsm</span>
<span class="w">    </span><span class="err">└──</span><span class="w"> </span><span class="n">pelican</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">fsm_renderer</span><span class="o">/</span>
<span class="w">        </span><span class="err">├──</span><span class="w"> </span><span class="n">__init__</span><span class="o">.</span><span class="n">py</span><span class="w">             </span><span class="c1"># plugin entry point, signal registration</span>
<span class="w">        </span><span class="err">└──</span><span class="w"> </span><span class="n">preprocessor</span><span class="o">.</span><span class="n">py</span><span class="w">        </span><span class="c1"># Markdown extension + preprocessor</span>

<span class="o">~/.</span><span class="n">claude</span><span class="o">/</span><span class="n">skills</span><span class="o">/</span>
<span class="err">└──</span><span class="w"> </span><span class="n">fsm</span><span class="o">/</span>
<span class="w">    </span><span class="err">└──</span><span class="w"> </span><span class="n">SKILL</span><span class="o">.</span><span class="n">md</span><span class="w">                    </span><span class="c1"># Claude Code skill definition</span>
</code></pre></div>

<p>The combination is useful for any documentation that involves control flow: describe the behaviour, get the diagram from Claude, drop it into a post, and the plugin renders it at build time. No manual editing of diagram syntax, no copy-pasting between browser tabs.</p>
      </div><!-- /.entry-content -->

    </article>
  </section>
                <section id="extras" class="body">
                                <div class="social">
                                        <h2>social</h2>
                                        <ul>
                                                        <li><a href="http://lizard-spock.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                                        </ul>
                                </div><!-- /.social -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

        </body>
</html>